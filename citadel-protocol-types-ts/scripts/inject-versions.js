#!/usr/bin/env node

/**
 * Version injection script for Citadel Protocol TypeScript types.
 *
 * This script reads version information from the Rust sources and generates
 * TypeScript exports for protocol_version() and sdk_version() functions.
 */

const fs = require('fs');
const path = require('path');

// Paths to source files
const CONSTANTS_PATH = path.join(__dirname, '../../citadel_proto/src/constants.rs');
const SDK_CARGO_PATH = path.join(__dirname, '../../citadel_sdk/Cargo.toml');
const OUTPUT_PATH = path.join(__dirname, '../src/versions.ts');

/**
 * Extract protocol version from constants.rs
 */
function getProtocolVersion() {
  const content = fs.readFileSync(CONSTANTS_PATH, 'utf-8');

  const majorMatch = content.match(/pub const MAJOR_VERSION:\s*u8\s*=\s*(\d+);/);
  const minorMatch = content.match(/pub const MINOR_VERSION:\s*u8\s*=\s*(\d+);/);
  const patchMatch = content.match(/pub const PATCH_VERSION:\s*u8\s*=\s*(\d+);/);

  if (!majorMatch || !minorMatch || !patchMatch) {
    throw new Error('Could not extract protocol version from constants.rs');
  }

  return `${majorMatch[1]}.${minorMatch[1]}.${patchMatch[1]}`;
}

/**
 * Extract SDK version from Cargo.toml
 */
function getSdkVersion() {
  const content = fs.readFileSync(SDK_CARGO_PATH, 'utf-8');

  const versionMatch = content.match(/^version\s*=\s*"([^"]+)"/m);

  if (!versionMatch) {
    throw new Error('Could not extract SDK version from citadel_sdk/Cargo.toml');
  }

  return versionMatch[1];
}

/**
 * Generate versions.ts content
 */
function generateVersionsTs(protocolVersion, sdkVersion) {
  return `// Auto-generated by scripts/inject-versions.js - DO NOT EDIT
// Generated at: ${new Date().toISOString()}

/**
 * Returns the Citadel Protocol version.
 *
 * This version is extracted from citadel_proto/src/constants.rs
 * (MAJOR_VERSION, MINOR_VERSION, PATCH_VERSION).
 *
 * @returns Semantic version string (e.g., "0.9.0")
 */
export function protocol_version(): string {
  return "${protocolVersion}";
}

/**
 * Returns the Citadel SDK version.
 *
 * This version is extracted from citadel_sdk/Cargo.toml.
 *
 * @returns Semantic version string (e.g., "0.13.0")
 */
export function sdk_version(): string {
  return "${sdkVersion}";
}
`;
}

// Main execution
try {
  const protocolVersion = getProtocolVersion();
  const sdkVersion = getSdkVersion();

  console.log(`Protocol version: ${protocolVersion}`);
  console.log(`SDK version: ${sdkVersion}`);

  const content = generateVersionsTs(protocolVersion, sdkVersion);
  fs.writeFileSync(OUTPUT_PATH, content);

  console.log(`Generated ${OUTPUT_PATH}`);
} catch (error) {
  console.error('Error:', error.message);
  process.exit(1);
}
